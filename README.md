# Домашнее задание к занятию 12.8. «`Резервное копирование баз данных`» - `Барановский Станислав`

**Домашнее задание выполните в Google Docs или в md-файле в вашем репозитории GitHub.** 

Для оформления вашего решения в GitHub можете воспользоваться [шаблоном](https://github.com/netology-code/sys-pattern-homework).

Название файла должно содержать номер лекции и фамилию студента. Пример названия: «12.8. Резервное копирование баз данных — Александр Александров».

Перед тем как выслать ссылку, убедитесь, что её содержимое не является приватным, то есть открыто на просмотр всем, у кого есть ссылка. Если необходимо прикрепить дополнительные ссылки, просто добавьте их в свой Google Docs.

Любые вопросы по решению задач задавайте в чате учебной группы.

---

## Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

**Подойдут варианты инкрементального или дифференциального резервного копирования, где инкрементальные или дифференциальные копии выполняются каждый день в ночное не рабочее время.**
На время выполнения резервного копирования БД останавливается. Если такой останов БД не возможен, то копирование файлов БД можно выполнить через snapshot файловой системы.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

**Для возможности восстановления данных на определенное время можно сочетать любое резервное копирование на уровне файловой системы с копированием файлов WAL (журнал предзаписи в СУБД Postgres)**
После аварии БД может быть востанновлена на определенный момент времени посредством воспроизведения всех изменений, внесенных в БД после восстановления файлов БД из контрольной точки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

**Такой кейс возможен :**
- при использовании репликации типа master-master или master-slave, где slave назначается новым мастером после поломки старого;
- при использовании горячего резервирования БД.

*Приведите ответ в свободной форме.*

---

## Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

```bash
#Выгрузка базы my-db-name в файл sql-скрипта :
pg_dump my-db-name > my-db-name.sql
#Загрузка из sql-скрипта : psql -d my-db-name -f my-db-name.sql

#Выгрузка базы в архивный файл :
pg_dump -Fc my-db-name > my-db-name-dump

#Выгрузка базы в архивный каталог :
pg_dump -Fd my-db-name -j 5 -f dumpdir

#Удалаяем базу :
dropdb my-db-name

#Восстанавливаем базу из архивного файла
pg_restore -Cd my-db-name my-db-name-dump

#Или новую базу сами создаем: createdb -T template0 my-db-name
#и в неё восстанавливаем данные из архивного файла :
pg_restore -d my-db-name my-db-name-dump
```
Справка по командам [pg_dump](https://www.postgresql.org/docs/15/app-pgdump.html) и [pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html). 

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

**Автоматизировать процесс резервирования данных можно с использованием планировщика cron**
Сохраняем скрипт в файл, например, postgres_dump.sh. Для запуска резервного копирования по расписанию создаем задание в планировщике с запуском скрипта каждый день в 02:00 :
```bash
crontab -e

   2 0 * * * /scripts/postgres_dump.sh
```

*Приведите ответ в свободной форме.*

---

## Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

```bash
#Команда создания полной резервнной копии всех БД, очистка двоичных журналов MySQL в момент полной резервной копии и удаление старых двоичных журналов.
#Чтобы создавать инкрементные резервные копии, нам нужно сохранить инкрементные изменения.
#В MySQL эти изменения представлены в двоичном журнале, поэтому сервер MySQL всегда следует запускать с --log-bin опцией для включения этого журнала.
mysqldump --all-databases --master-data=2 --single-transaction --flush-logs --delete-master-logs > full_backup_all_db.sql

#Команда восстановления БД из полной резервной копии :
mysql < full_backup_all_db.sql

#Команда восстановления БД из инкрементной резервной копии (двоичных журналов) :
mysqlbinlog gbichot2-bin.000007 gbichot2-bin.000008 | mysql
```

Справка по командам [mysqldump](https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html) и [mysqlbinlog](https://dev.mysql.com/doc/refman/8.0/en/mysqlbinlog.html).

[Пример стратегии резервного копирования и восстановления](https://dev.mysql.com/doc/refman/8.0/en/backup-strategy-example.html).

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

**Реплика - это полная копия БД, но при этом не является резервной копией.**
Репликация позволяет в случае сбоя продолжать предоставлять сервис (доступ к БД) за счет избыточного резервирования.

*Приведите ответ в свободной форме.*

---
